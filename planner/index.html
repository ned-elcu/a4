<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SOLIS Planner</title>
  <link rel="icon" href="https://regnumsolis.com/planner/images/icon.png" type="image/png">
  <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap">
  <style>
    /* Reset and base styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      width: 100%;
      height: 100%;
      background: transparent;
      color: white;
      font-family: 'Bebas Neue', sans-serif;
      overflow: hidden;
      position: relative;
    }
    /* Global style for marker text and background toggle */
    .text-hover-only .marker text,
    .text-hover-only .marker rect {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .text-hover-only .marker:hover text,
    .text-hover-only .marker:hover rect {
      opacity: 1;
    }
    /* Background container and animated canvas */
    #background-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
    }
    /* The canvas now hosts the WebGL animated ocean */
    #waveCanvas {
      display: block;
      width: 100%;
      height: 100%;
    }
    /* Loading overlay */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 100;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      font-size: 2em;
    }
    #loading-overlay img {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
    }
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes neonGlow {
      0% {
        text-shadow: 0 0 5px rgba(223,197,136,0.6),
                     0 0 10px rgba(223,197,136,0.6),
                     0 0 15px rgba(223,197,136,0.6);
      }
      100% {
        text-shadow: 0 0 20px rgba(223,197,136,1),
                     0 0 30px rgba(223,197,136,1),
                     0 0 40px rgba(223,197,136,1);
      }
    }
    /* Login screen */
    #login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: rgba(30,30,30,0.9);
      animation: fadeIn 1s ease-out;
      text-align: center;
      position: relative;
      z-index: 1;
    }
    #login-screen h2 {
      font-size: 3em;
      margin-bottom: 20px;
      animation: neonGlow 1.5s infinite alternate ease-in-out;
    }
    #login-screen input {
      margin: 5px;
      padding: 10px;
      font-size: 1.2em;
      width: 250px;
      border: none;
      border-radius: 4px;
      text-align: center;
    }
    #login-screen button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 1.2em;
      border: none;
      border-radius: 4px;
      background: rgba(223,197,136,0.8);
      color: white;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      box-shadow: 0 4px 15px rgba(223,197,136,0.5);
    }
    #login-screen button:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(223,197,136,0.9);
    }
    #login-error {
      margin-top: 10px;
      color: #e74c3c;
      font-weight: bold;
    }
    /* Main app container */
    #app {
      display: none;
      height: 100vh;
      position: relative;
      animation: fadeIn 1s ease-out;
      z-index: 1;
    }
    /* Header text */
    #header-logo {
      text-align: center;
      padding: 10px 0;
      background: transparent;
    }
    #header-logo h1 {
      font-size: 1.05em;
      margin: 0;
      color: rgb(223,197,136);
      text-shadow: 0 0 5px rgba(223,197,136,0.8);
      animation: neonGlow 1.5s infinite alternate ease-in-out;
    }
    /* Right-side menus (map change, zoom controls, and markers menu) */
    .menu-container {
      width: 180px;
      background: rgba(30,30,30,0.9);
      padding: 10px;
      border: 1px solid rgba(223,197,136,0.5);
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(223,197,136,0.5);
      display: flex;
      flex-direction: column;
      gap: 5px;
      align-items: center;
    }
    /* Map change controls */
    #map-change-container {
      position: fixed;
      top: 100px;
      right: 20px;
      z-index: 20;
    }
    #map-change-container h2 {
      font-size: 1.2em;
      margin-bottom: 5px;
    }
    /* Zoom controls */
    #zoom-controls {
      position: fixed;
      top: 260px;
      right: 20px;
      z-index: 20;
    }
    /* Markers menu (Right Side) */
    #markers-menu {
      position: fixed;
      top: 420px;
      right: 20px;
      z-index: 20;
      width: 180px;
      background: rgba(30,30,30,0.9);
      padding: 10px;
      border: 1px solid rgba(223,197,136,0.5);
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(223,197,136,0.5);
      text-align: center;
    }
    #markers-menu h2 {
      font-size: 1em;
      margin-bottom: 5px;
    }
    /* Marker text toggle inside markers menu */
    #marker-text-toggle-container {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
    }
    #toggle-marker-text {
      appearance: none;
      -webkit-appearance: none;
      width: 40px;
      height: 20px;
      background: #ccc;
      border-radius: 20px;
      position: relative;
      outline: none;
      cursor: pointer;
      transition: background 0.3s;
      margin-right: 8px;
    }
    #toggle-marker-text:checked {
      background: #dfc588;
    }
    #toggle-marker-text::before {
      content: "";
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    #toggle-marker-text:checked::before {
      transform: translateX(20px);
    }
    #toggle-marker-text-label {
      font-size: 0.9em;
    }
    /* Markers filter checkboxes */
    #markers-filter label {
      display: block;
      font-size: 0.9em;
      margin-bottom: 5px;
      cursor: pointer;
    }
    /* Toolbox */
    #toolbox {
      position: fixed;
      top: 180px;
      left: 20px;
      background: rgba(30,30,30,0.9);
      padding: 10px;
      border: 1px solid rgba(223,197,136,0.5);
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(223,197,136,0.5);
      z-index: 20;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .tool {
      width: 50px;
      height: 50px;
      border: 1px solid rgba(223,197,136,0.5);
      background: rgba(30,30,30,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 5px;
      transition: transform 0.3s;
    }
    .tool:hover {
      transform: scale(1.1);
    }
    .tool img {
      max-width: 100%;
      max-height: 100%;
    }
    /* Map container */
    #map-container {
      width: 100vw;
      height: calc(100vh - 60px);
      overflow: hidden;
    }
    #map-svg-container {
      width: 100%;
      height: 100%;
    }
    .marker:hover {
      opacity: 0.8;
      cursor: pointer;
    }
    /* Error overlay */
    #error-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(30,30,30,0.95);
      color: #ecf0f1;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      font-size: 1.5em;
      text-align: center;
      padding: 20px;
    }
    /* Admin panel */
    #admin-panel {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 320px;
      background: rgba(30,30,30,0.9);
      border: 1px solid rgba(223,197,136,0.5);
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(223,197,136,0.5);
      padding: 10px;
      z-index: 30;
      display: none;
      animation: fadeIn 1s ease-out;
    }
    #admin-panel h3 {
      margin-top: 0;
      font-size: 1.8em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(223,197,136,0.5);
      padding-bottom: 5px;
      margin-bottom: 10px;
    }
    #admin-panel h3 span.icon {
      cursor: pointer;
      margin-left: 5px;
      font-size: 1.2em;
    }
    #audit-log {
      font-size: 0.9em;
      height: 200px;
      overflow-y: auto;
      margin-bottom: 10px;
      border-top: 1px solid rgba(223,197,136,0.5);
      padding-top: 5px;
    }
    /* Admin log button style applied to right menu buttons */
    .menu-container button {
      width: 100%;
      height: 40px;
      border: none;
      border-radius: 4px;
      background: rgba(223,197,136,0.8);
      color: white;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      box-shadow: 0 4px 15px rgba(223,197,136,0.5);
    }
    .menu-container button:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(223,197,136,0.9);
    }
    /* Existing delete all markers button styling remains unchanged */
    #delete-all {
      width: 100%;
      height: 40px;
      border: none;
      border-radius: 4px;
      background: rgba(223,197,136,0.8);
      color: white;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      box-shadow: 0 4px 15px rgba(223,197,136,0.5);
    }
    #delete-all:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(223,197,136,0.9);
    }
  </style>
</head>
<body>
  <!-- Animated waves background using WebGL -->
  <div id="background-container">
    <canvas id="waveCanvas"></canvas>
  </div>

  <!-- Loading overlay -->
  <div id="loading-overlay">
    <img src="https://regnumsolis.com/planner/images/loading.gif" alt="Loading">
    <div id="loading-text">0%</div>
  </div>

  <!-- Login Screen -->
  <div id="login-screen">
    <h2>Login</h2>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button id="login-button">Login</button>
    <div id="login-error"></div>
  </div>

  <!-- Main App -->
  <div id="app">
    <!-- Header -->
    <div id="header-logo">
      <h1>REGNUM SOLIS R&D / REMNANT SENATE</h1>
    </div>

    <!-- Map Change Menu -->
    <div id="map-change-container" class="menu-container">
      <h2>Change Maps</h2>
      <button id="tactical-map">Tactical Map</button>
      <button id="style-map">Style Map</button>
    </div>

    <!-- Zoom Controls -->
    <div id="zoom-controls" class="menu-container">
      <button id="zoom-in">Zoom In</button>
      <button id="zoom-out">Zoom Out</button>
      <button id="reset-zoom">Reset</button>
    </div>

    <!-- Markers Menu (Right Side) -->
    <div id="markers-menu">
      <h2>Markers Menu</h2>
      <!-- Marker Text Toggle -->
      <div id="marker-text-toggle-container">
        <input type="checkbox" id="toggle-marker-text">
        <label for="toggle-marker-text" id="toggle-marker-text-label">SWITCH TO ALL</label>
      </div>
      <!-- Markers Filter -->
      <div id="markers-filter">
        <label><input type="checkbox" value="marker" checked> homestead</label>
        <label><input type="checkbox" value="citadel" checked> Citadel</label>
        <label><input type="checkbox" value="torch" checked> Torch</label>
        <label><input type="checkbox" value="cave" checked> Cave</label>
        <label><input type="checkbox" value="sword" checked> Sword</label>
        <label><input type="checkbox" value="spear" checked> Spear</label>
        <label><input type="checkbox" value="bow" checked> Bow</label>
        <label><input type="checkbox" value="beacon" checked> Beacon</label>
        <label><input type="checkbox" value="camp" checked> Camp</label>
        <label><input type="checkbox" value="catapult" checked> Catapult</label>
        <label><input type="checkbox" value="ram" checked> Ram</label>
        <label><input type="checkbox" value="line" checked> Lines</label>
      </div>
    </div>

    <!-- Toolbox -->
    <div id="toolbox">
      <div class="tool" draggable="true" data-type="marker" title="homestead">
        <img src="https://regnumsolis.com/planner/images/marker.svg" alt="Marker">
      </div>
      <div class="tool" draggable="true" data-type="citadel" title="Citadel">
        <img src="https://regnumsolis.com/planner/images/citadel.svg" alt="Citadel">
      </div>
      <div class="tool" draggable="true" data-type="torch" title="Torch">
        <img src="https://regnumsolis.com/planner/images/torch.svg" alt="Torch">
      </div>
      <div class="tool" draggable="true" data-type="cave" title="Cave">
        <img src="https://regnumsolis.com/planner/images/cave.svg" alt="Cave">
      </div>
      <div class="tool" draggable="true" data-type="sword" title="Sword">
        <img src="https://regnumsolis.com/planner/images/sword.svg" alt="Sword">
      </div>
      <div class="tool" draggable="true" data-type="spear" title="Spear">
        <img src="https://regnumsolis.com/planner/images/spear.svg" alt="Spear">
      </div>
      <div class="tool" draggable="true" data-type="bow" title="Bow">
        <img src="https://regnumsolis.com/planner/images/bow.svg" alt="Bow">
      </div>
      <div class="tool" data-type="line" title="Line Draw">
        <img src="https://regnumsolis.com/planner/images/line.svg" alt="Line Draw" onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22><text x=%220%22 y=%2230%22 fill=%22white%22 font-size=%2230%22>‚Äï</text></svg>'">
      </div>
      <!-- New markers added below -->
      <div class="tool" draggable="true" data-type="beacon" title="Beacon">
        <img src="https://regnumsolis.com/planner/images/beacon.svg" alt="Beacon">
      </div>
      <div class="tool" draggable="true" data-type="camp" title="Camp">
        <img src="https://regnumsolis.com/planner/images/camp.svg" alt="Camp">
      </div>
      <div class="tool" draggable="true" data-type="catapult" title="Catapult">
        <img src="https://regnumsolis.com/planner/images/catapult.svg" alt="Catapult">
      </div>
      <div class="tool" draggable="true" data-type="ram" title="Ram">
        <img src="https://regnumsolis.com/planner/images/ram.svg" alt="Ram">
      </div>
    </div>

    <!-- Map Container -->
    <div id="map-container">
      <div id="map-svg-container"></div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel">
      <h3>
        Audit log
        <span>
          <span id="delete-audit" class="icon" title="Delete all audit logs">üóëÔ∏è</span>
          <span id="minimize-audit" class="icon" title="Minimize audit log">‚ûñ</span>
          <span id="copy-audit" class="icon" title="Copy audit log">üìã</span>
        </span>
      </h3>
      <div id="audit-log"></div>
      <button id="delete-all">Delete All Markers</button>
    </div>
  </div>

  <div id="error-overlay">Database connection failed. The app cannot be used at this time.</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, orderBy, query, onSnapshot, deleteDoc, doc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIws_FKV_CTaiHdnwc8WigDqRkyUCOjtE",
      authDomain: "regnum-d3ddf.firebaseapp.com",
      projectId: "regnum-d3ddf",
      storageBucket: "regnum-d3ddf.firebasestorage.app",
      messagingSenderId: "565532905074",
      appId: "1:565532905074:web:a4cc38363376e49540fceb",
      measurementId: "G-4RG5NP4FZ3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let panZoomInstance, svgRoot, panLayer, lineLayer, markerLayer;
    let isMapReady = false;
    const adminEmail = "gryves_dev@yahoo.com";

    let activeTool = null;
    let lineDrawingState = 0;
    let currentLine = null;
    let currentLineGroup = null;

    // Loading simulation
    let loadingInterval;
    let currentProgress = 0;
    const loadingOverlay = document.getElementById("loading-overlay");
    const loadingText = document.getElementById("loading-text");

    document.addEventListener("DOMContentLoaded", () => {
      setupLogin();
      setupToolbox();
      setupAuditControls();
      setupMapSwitchControls();
      setupMarkerFilter();
      setupMarkerTextToggle();
    });

    function showLoading() {
      currentProgress = 0;
      loadingText.textContent = "0%";
      loadingOverlay.style.display = "flex";
      loadingInterval = setInterval(() => {
        if (currentProgress < 90) {
          currentProgress += Math.floor(Math.random() * 3) + 1;
          if (currentProgress > 90) currentProgress = 90;
          loadingText.textContent = currentProgress + "%";
        }
      }, 100);
    }

    function hideLoading() {
      clearInterval(loadingInterval);
      loadingText.textContent = "100%";
      setTimeout(() => {
        loadingOverlay.style.display = "none";
      }, 300);
    }

    function setupLogin() {
      document.getElementById("login-button").addEventListener("click", () => {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();
        const errorDiv = document.getElementById("login-error");

        signInWithEmailAndPassword(auth, email, password)
          .then(() => {
            errorDiv.textContent = "";
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("app").style.display = "block";
            initializeMap();
          })
          .catch((error) => {
            errorDiv.textContent = error.message;
          });
      });

      onAuthStateChanged(auth, (user) => {
        if (user) {
          document.getElementById("login-screen").style.display = "none";
          document.getElementById("app").style.display = "block";
          initializeMap();
          if (user.email === adminEmail) {
            document.getElementById("admin-panel").style.display = "block";
            listenForAuditLogs();
            setupDeleteAll();
          }
        } else {
          document.getElementById("login-screen").style.display = "flex";
          document.getElementById("app").style.display = "none";
        }
      });
    }

    // Set default map to Style Map.
    function initializeMap() {
      switchMap("https://regnumsolis.com/planner/images/mvmvmdfs.svg");
    }

    // switchMap shows the loading overlay, fetches the SVG, then initializes pan/zoom and listeners.
    function switchMap(url) {
      if (panZoomInstance) {
        panZoomInstance.destroy();
      }
      isMapReady = false;
      const container = document.getElementById("map-svg-container");
      showLoading();
      fetch(url)
        .then(response => response.text())
        .then(svgText => {
          container.innerHTML = svgText;
          setupPanZoomLayers();
          setupZoomControls();
          setupDragAndDrop();
          setupLineDrawing();
          listenForMarkers();
          listenForLines();
          isMapReady = true;
          hideLoading();
        })
        .catch(error => {
          console.error("Error loading SVG:", error);
          displayErrorOverlay("Error loading map data.");
          hideLoading();
        });
    }

    // Setup the map switch controls.
    function setupMapSwitchControls() {
      document.getElementById("tactical-map").addEventListener("click", () => {
        switchMap("https://regnumsolis.com/planner/images/mvmvmdfstactical.svg");
      });
      document.getElementById("style-map").addEventListener("click", () => {
        switchMap("https://regnumsolis.com/planner/images/mvmvmdfs.svg");
      });
    }

    function setupPanZoomLayers() {
      svgRoot = document.getElementById("map-svg-container").querySelector("svg");
      svgRoot.setAttribute("width", "100%");
      svgRoot.setAttribute("height", "100%");
      svgRoot.setAttribute("preserveAspectRatio", "xMidYMid meet");

      panLayer = document.createElementNS("http://www.w3.org/2000/svg", "g");
      panLayer.id = "pan-layer";
      while (svgRoot.firstChild) {
        panLayer.appendChild(svgRoot.firstChild);
      }
      svgRoot.appendChild(panLayer);

      lineLayer = document.createElementNS("http://www.w3.org/2000/svg", "g");
      lineLayer.id = "line-layer";
      panLayer.appendChild(lineLayer);

      markerLayer = document.createElementNS("http://www.w3.org/2000/svg", "g");
      markerLayer.id = "marker-layer";
      panLayer.appendChild(markerLayer);

      panZoomInstance = svgPanZoom(svgRoot, {
        zoomEnabled: true,
        panEnabled: true,
        controlIconsEnabled: false,
        minZoom: 0.5,
        maxZoom: 5,
        beforeMouseDown: function(e) {
          if (activeTool === "line") return false;
          if (e.target.getAttribute("data-marker") === "true" ||
              (e.target.parentNode && e.target.parentNode.getAttribute("data-marker") === "true")) {
            return false;
          }
          return true;
        }
      });
    }

    function setupZoomControls() {
      document.getElementById("zoom-in").addEventListener("click", () => panZoomInstance.zoomIn());
      document.getElementById("zoom-out").addEventListener("click", () => panZoomInstance.zoomOut());
      document.getElementById("reset-zoom").addEventListener("click", () => panZoomInstance.resetZoom());
    }

    function setupToolbox() {
      document.querySelectorAll(".tool").forEach((tool) => {
        const type = tool.dataset.type;
        if (type === "line") {
          tool.addEventListener("click", () => {
            activeTool = "line";
            lineDrawingState = 0;
            markerLayer.style.pointerEvents = "none";
            document.querySelectorAll(".tool").forEach(t => t.style.borderColor = "rgba(223,197,136,0.5)");
            tool.style.borderColor = "red";
          });
        } else {
          tool.addEventListener("dragstart", (e) => {
            e.dataTransfer.setData("text/plain", type);
          });
        }
      });
    }

    function setupAuditControls() {
      document.getElementById("delete-audit").addEventListener("click", async () => {
        if (confirm("Delete all audit logs?")) {
          try {
            const auditSnapshot = await getDocs(collection(db, "auditLogs"));
            auditSnapshot.forEach(async (docSnap) => {
              await deleteDoc(doc(db, "auditLogs", docSnap.id));
            });
          } catch (error) {
            console.error("Error deleting audit logs:", error);
          }
        }
      });

      document.getElementById("minimize-audit").addEventListener("click", () => {
        const auditLogDiv = document.getElementById("audit-log");
        if (auditLogDiv.style.display === "none") {
          auditLogDiv.style.display = "block";
          document.getElementById("minimize-audit").textContent = "‚ûñ";
        } else {
          auditLogDiv.style.display = "none";
          document.getElementById("minimize-audit").textContent = "‚ûï";
        }
      });
      
      document.getElementById("copy-audit").addEventListener("click", () => {
        const auditLogContainer = document.getElementById("audit-log");
        const textToCopy = auditLogContainer.textContent;
        navigator.clipboard.writeText(textToCopy)
          .then(() => {
            alert("Audit log copied to clipboard!");
          })
          .catch((error) => {
            alert("Failed to copy audit log.");
          });
      });
    }

    // Setup the marker filter checkboxes (including the new Lines option).
    function setupMarkerFilter() {
      const checkboxes = document.querySelectorAll("#markers-filter input[type='checkbox']");
      checkboxes.forEach(cb => {
        cb.addEventListener("change", updateVisibility);
      });
    }

    // Update marker and line visibility based on filter checkboxes.
    function updateVisibility() {
      const checkboxes = document.querySelectorAll("#markers-filter input[type='checkbox']");
      let visibleTypes = {};
      checkboxes.forEach(cb => {
        visibleTypes[cb.value] = cb.checked;
      });
      // Update markers
      if (markerLayer) {
        Array.from(markerLayer.children).forEach(marker => {
          if (marker.dataset && marker.dataset.type) {
            marker.style.display = visibleTypes[marker.dataset.type] ? "block" : "none";
          }
        });
      }
      // Update lines (lineLayer)
      if (lineLayer) {
        lineLayer.style.display = visibleTypes["line"] ? "block" : "none";
      }
    }

    // Setup the marker text toggle inside the markers menu.
    function setupMarkerTextToggle() {
      const toggle = document.getElementById("toggle-marker-text");
      const toggleLabel = document.getElementById("toggle-marker-text-label");
      // Default: text-hover-only is active (i.e. marker text only on hover)
      document.body.classList.add("text-hover-only");
      toggle.checked = false;
      toggleLabel.textContent = "SWITCH TO ALL";
      
      toggle.addEventListener("change", function() {
        if (this.checked) {
          // When checked, remove the hover-only class so that marker text is always visible.
          document.body.classList.remove("text-hover-only");
          toggleLabel.textContent = "SWITCH TO HOVER";
        } else {
          // When unchecked, add the class so that marker text is visible only on hover.
          document.body.classList.add("text-hover-only");
          toggleLabel.textContent = "SWITCH TO ALL";
        }
      });
    }

    function getSVGPoint(e) {
      const pt = svgRoot.createSVGPoint();
      pt.x = e.clientX;
      pt.y = e.clientY;
      return pt.matrixTransform(panLayer.getScreenCTM().inverse());
    }

    function setupDragAndDrop() {
      svgRoot.addEventListener("dragover", (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
      });

      svgRoot.addEventListener("drop", async (e) => {
        if (!isMapReady || activeTool === "line") return;
        e.preventDefault();
        const type = e.dataTransfer.getData("text/plain");
        const cursorPos = getSVGPoint(e);
        await addMarkerToFirestore(type, cursorPos.x, cursorPos.y);
      });
    }

    function setupLineDrawing() {
      svgRoot.addEventListener("click", async (e) => {
        if (activeTool !== "line") return;
        e.preventDefault();
        const pt = getSVGPoint(e);

        if (lineDrawingState === 0) {
          currentLineGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
          currentLineGroup.classList.add("line-group");

          const lineColor = prompt("Enter line color (e.g., red or #ff0000):") || "white";
          
          currentLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
          currentLine.setAttribute("x1", pt.x);
          currentLine.setAttribute("y1", pt.y);
          currentLine.setAttribute("x2", pt.x);
          currentLine.setAttribute("y2", pt.y);
          currentLine.setAttribute("stroke-width", "3.2");
          currentLine.setAttribute("stroke", lineColor);

          currentLineGroup.startPoint = { x: pt.x, y: pt.y };
          currentLineGroup.lineColor = lineColor;
          currentLineGroup.appendChild(currentLine);
          lineLayer.appendChild(currentLineGroup);

          lineDrawingState = 1;
        } else if (lineDrawingState === 1) {
          const x1 = currentLineGroup.startPoint.x;
          const y1 = currentLineGroup.startPoint.y;
          const x2 = pt.x;
          const y2 = pt.y;

          currentLine.setAttribute("x2", x2);
          currentLine.setAttribute("y2", y2);

          const midX = (x1 + x2) / 2;
          const midY = (y1 + y2) / 2;
          const angle = Math.atan2(y2 - y1, x2 - x1) * (180 / Math.PI);

          const arrow = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
          arrow.setAttribute("points", "0,-8 16,0 0,8");
          arrow.setAttribute("fill", currentLineGroup.lineColor);
          arrow.setAttribute("transform", `translate(${midX},${midY}) rotate(${angle})`);
          currentLineGroup.appendChild(arrow);

          await addLineToFirestore({
            x1, y1, x2, y2,
            color: currentLineGroup.lineColor,
            midX, midY, angle
          });

          activeTool = null;
          lineDrawingState = 0;
          currentLine = null;
          currentLineGroup = null;
          markerLayer.style.pointerEvents = "auto";
          document.querySelectorAll(".tool").forEach(t => t.style.borderColor = "rgba(223,197,136,0.5)");
        }
      });
    }

    async function addMarkerToFirestore(type, x, y) {
      let markerData = { type, x, y, timestamp: serverTimestamp() };
      if (["marker", "citadel", "torch", "cave", "sword", "spear", "bow", "beacon", "camp", "catapult", "ram"].includes(type)) {
        markerData.text = prompt("Enter marker text:") || "";
        markerData.color = prompt("Enter marker color (e.g., red or #ff0000):") || "black";
        if (type === "marker" && markerData.text === "") {
          // Default changed from "M" to "homestead"
          markerData.text = "homestead";
        }
      }
      try {
        const docRef = await addDoc(collection(db, "markers"), markerData);
        recordAuditLog("add", { markerId: docRef.id, markerType: type });
      } catch (error) {
        console.error("Error adding marker:", error);
      }
    }

    async function addLineToFirestore(lineData) {
      try {
        const docRef = await addDoc(collection(db, "lines"), {
          ...lineData,
          timestamp: serverTimestamp()
        });
        recordAuditLog("add_line", { lineId: docRef.id });
      } catch (error) {
        console.error("Error adding line:", error);
      }
    }

    function listenForMarkers() {
      let snapshotReceived = false;
      const markersQuery = query(collection(db, "markers"), orderBy("timestamp"));
      const unsubscribe = onSnapshot(markersQuery, (snapshot) => {
        snapshotReceived = true;
        while (markerLayer.firstChild) {
          markerLayer.removeChild(markerLayer.firstChild);
        }
        snapshot.forEach((docSnap) => {
          createMarkerElement(docSnap.id, docSnap.data());
        });
        updateVisibility();
      }, (error) => {
        console.error("Firestore connection error:", error);
        displayErrorOverlay("Firestore connection failed.");
      });

      setTimeout(() => {
        if (!snapshotReceived) {
          console.error("No Firestore snapshot received within timeout.");
          displayErrorOverlay("Firestore connection failed.");
          unsubscribe();
        }
      }, 5000);
    }

    function listenForLines() {
      const linesQuery = query(collection(db, "lines"), orderBy("timestamp"));
      onSnapshot(linesQuery, (snapshot) => {
        lineLayer.innerHTML = "";
        snapshot.forEach((docSnap) => {
          createLineElement(docSnap.id, docSnap.data());
        });
      });
    }

    function createMarkerElement(id, data) {
      let markerEl = document.createElementNS("http://www.w3.org/2000/svg", "g");
      markerEl.setAttribute("data-marker", "true");
      markerEl.dataset.type = data.type;
      
      let imgSrc, imgWidth, imgHeight, imgXOffset, imgYOffset, fontSize;
      if (data.type === "marker") {
        imgSrc = "https://regnumsolis.com/planner/images/marker.svg";
        imgWidth = 30 * 1.7;
        imgHeight = 30 * 1.7;
        imgXOffset = -(imgWidth / 2);
        imgYOffset = -20 * 1.7;
        fontSize = 16 * 1.7;
      } else if (data.type === "citadel") {
        imgSrc = "https://regnumsolis.com/planner/images/citadel.svg";
        imgWidth = 30 * 1.7 * 1.2;
        imgHeight = 30 * 1.7 * 1.2;
        imgXOffset = -15 * 1.7 * 1.2;
        imgYOffset = -15 * 1.7 * 1.2;
        fontSize = 14 * 1.7 * 1.2;
      } else if (data.type === "torch") {
        imgSrc = "https://regnumsolis.com/planner/images/torch.svg";
        imgWidth = 30 * 1.7;
        imgHeight = 30 * 1.7;
        imgXOffset = -15 * 1.7;
        imgYOffset = -15 * 1.7;
        fontSize = 14 * 1.7;
      } else if (data.type === "cave") {
        imgSrc = "https://regnumsolis.com/planner/images/cave.svg";
        imgWidth = 30 * 1.7;
        imgHeight = 30 * 1.7;
        imgXOffset = -15 * 1.7;
        imgYOffset = -15 * 1.7;
        fontSize = 14 * 1.7;
      } else if (data.type === "sword") {
        imgSrc = "https://regnumsolis.com/planner/images/sword.svg";
        imgWidth = 30 * 1.7;
        imgHeight = 30 * 1.7;
        imgXOffset = -15 * 1.7;
        imgYOffset = -15 * 1.7;
        fontSize = 14 * 1.7;
      } else if (data.type === "spear") {
        imgSrc = "https://regnumsolis.com/planner/images/spear.svg";
        imgWidth = 30 * 1.7;
        imgHeight = 30 * 1.7;
        imgXOffset = -15 * 1.7;
        imgYOffset = -15 * 1.7;
        fontSize = 14 * 1.7;
      } else if (data.type === "bow") {
        imgSrc = "https://regnumsolis.com/planner/images/bow.svg";
        imgWidth = 30 * 1.7;
        imgHeight = 30 * 1.7;
        imgXOffset = -15 * 1.7;
        imgYOffset = -15 * 1.7;
        fontSize = 14 * 1.7;
      } else if (data.type === "beacon") {
        imgSrc = "https://regnumsolis.com/planner/images/beacon.svg";
        imgWidth = 30 * 1.7;
        imgHeight = 30 * 1.7;
        imgXOffset = -15 * 1.7;
        imgYOffset = -15 * 1.7;
        fontSize = 14 * 1.7;
      } else if (data.type === "camp") {
        imgSrc = "https://regnumsolis.com/planner/images/camp.svg";
        imgWidth = 30 * 1.7;
        imgHeight = 30 * 1.7;
        imgXOffset = -15 * 1.7;
        imgYOffset = -15 * 1.7;
        fontSize = 14 * 1.7;
      } else if (data.type === "catapult") {
        imgSrc = "https://regnumsolis.com/planner/images/catapult.svg";
        imgWidth = 30 * 1.7;
        imgHeight = 30 * 1.7;
        imgXOffset = -15 * 1.7;
        imgYOffset = -15 * 1.7;
        fontSize = 14 * 1.7;
      } else if (data.type === "ram") {
        imgSrc = "https://regnumsolis.com/planner/images/ram.svg";
        imgWidth = 30 * 1.7;
        imgHeight = 30 * 1.7;
        imgXOffset = -15 * 1.7;
        imgYOffset = -15 * 1.7;
        fontSize = 14 * 1.7;
      }
      
      const image = document.createElementNS("http://www.w3.org/2000/svg", "image");
      image.setAttributeNS(null, "href", imgSrc);
      image.setAttribute("width", imgWidth);
      image.setAttribute("height", imgHeight);
      image.setAttribute("x", imgXOffset);
      image.setAttribute("y", imgYOffset);
      markerEl.appendChild(image);
      
      if (data.text) {
        const textEl = document.createElementNS("http://www.w3.org/2000/svg", "text");
        textEl.textContent = data.text;
        textEl.setAttribute("x", 0);
        textEl.setAttribute("y", imgYOffset + imgHeight + fontSize);
        textEl.setAttribute("font-size", fontSize);
        textEl.setAttribute("fill", data.color || "black");
        textEl.setAttribute("text-anchor", "middle");
        markerEl.appendChild(textEl);
      }
      
      markerLayer.appendChild(markerEl);
    }

    function createLineElement(id, data) {
      const lineGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
      lineGroup.classList.add("line-group");
      
      const lineEl = document.createElementNS("http://www.w3.org/2000/svg", "line");
      lineEl.setAttribute("x1", data.x1);
      lineEl.setAttribute("y1", data.y1);
      lineEl.setAttribute("x2", data.x2);
      lineEl.setAttribute("y2", data.y2);
      lineEl.setAttribute("stroke-width", "3.2");
      lineEl.setAttribute("stroke", data.color);
      lineGroup.appendChild(lineEl);
      
      // Recreate the arrow indicator
      const arrow = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
      arrow.setAttribute("points", "0,-8 16,0 0,8");
      arrow.setAttribute("fill", data.color);
      arrow.setAttribute("transform", `translate(${data.midX},${data.midY}) rotate(${data.angle})`);
      lineGroup.appendChild(arrow);
      
      lineLayer.appendChild(lineGroup);
    }

    function recordAuditLog(action, details) {
      // Placeholder function for audit logging.
      // In production, this would record details to your auditLogs collection.
      console.log("Audit log:", action, details);
    }

    function displayErrorOverlay(message) {
      document.getElementById("error-overlay").textContent = message;
      document.getElementById("error-overlay").style.display = "flex";
    }

    // Placeholder for audit log listener.
    function listenForAuditLogs() {
      // Implementation for listening to audit logs.
    }

    // Placeholder for delete all markers functionality.
    function setupDeleteAll() {
      document.getElementById("delete-all").addEventListener("click", () => {
        if (confirm("Are you sure you want to delete all markers?")) {
          // Implementation to delete markers.
          console.log("Delete all markers clicked.");
        }
      });
    }
  </script>
</body>
</html>
