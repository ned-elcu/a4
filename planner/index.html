<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SOLIS Planner</title>
  <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap">
  <style>
    /* Reset and base styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      width: 100%;
      height: 100%;
      background: transparent;
      color: white;
      font-family: 'Bebas Neue', sans-serif;
      overflow: hidden;
      position: relative;
    }
    /* Background container and animated canvas */
    #background-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
    }
    #waveCanvas {
      display: block;
      width: 100%;
      height: 100%;
    }
    /* Loading overlay */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 100;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      font-size: 2em;
    }
    #loading-overlay img {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
    }
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes neonGlow {
      0% {
        text-shadow: 0 0 5px rgba(223,197,136,0.8),
                     0 0 10px rgba(223,197,136,0.8),
                     0 0 15px rgba(223,197,136,0.8);
      }
      100% {
        text-shadow: 0 0 20px rgba(223,197,136,0.8),
                     0 0 30px rgba(223,197,136,0.8),
                     0 0 40px rgba(223,197,136,0.8);
      }
    }
    /* Login screen */
    #login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: rgba(30,30,30,0.9);
      animation: fadeIn 1s ease-out;
      text-align: center;
      position: relative;
      z-index: 1;
    }
    #login-screen h2 {
      font-size: 3em;
      margin-bottom: 20px;
      animation: neonGlow 1.5s infinite alternate ease-in-out;
    }
    #login-screen input {
      margin: 5px;
      padding: 10px;
      font-size: 1.2em;
      width: 250px;
      border: none;
      border-radius: 4px;
      text-align: center;
    }
    #login-screen button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 1.2em;
      border: none;
      border-radius: 4px;
      background: rgba(223,197,136,0.8);
      color: white;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      box-shadow: 0 4px 15px rgba(223,197,136,0.5);
    }
    #login-screen button:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(223,197,136,0.9);
    }
    #login-error {
      margin-top: 10px;
      color: #e74c3c;
      font-weight: bold;
    }
    /* Main app container */
    #app {
      display: none;
      height: 100vh;
      position: relative;
      animation: fadeIn 1s ease-out;
      z-index: 1;
    }
    /* Header text instead of logo */
    #header-logo {
      text-align: center;
      padding: 10px 0;
      background: transparent;
    }
    #header-logo h1 {
      font-size: 1.5em;
      margin: 0;
      color: rgb(223,197,136);
      text-shadow: 0 0 5px rgba(223,197,136,0.8);
    }
    /* Map change controls container */
    #map-change-container {
      position: fixed;
      top: 100px;
      right: 20px;
      z-index: 20;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      background: rgba(30,30,30,0.9);
      padding: 10px;
      border: 1px solid rgba(223,197,136,0.5);
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(223,197,136,0.5);
    }
    #map-change-container h2 {
      font-size: 1.2em;
      margin-bottom: 5px;
    }
    #map-change-container button {
      padding: 8px;
      border: none;
      border-radius: 4px;
      background: rgba(223,197,136,0.8);
      color: white;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      box-shadow: 0 4px 15px rgba(223,197,136,0.5);
      font-family: 'Bebas Neue', sans-serif;
    }
    #map-change-container button:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(223,197,136,0.9);
    }
    /* Toolbox */
    #toolbox {
      position: fixed;
      top: 160px;
      left: 20px;
      background: rgba(30,30,30,0.9);
      padding: 10px;
      border: 1px solid rgba(223,197,136,0.5);
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(223,197,136,0.5);
      z-index: 20;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .tool {
      width: 50px;
      height: 50px;
      border: 1px solid rgba(223,197,136,0.5);
      background: rgba(30,30,30,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-radius: 5px;
      transition: transform 0.3s;
    }
    .tool:hover {
      transform: scale(1.1);
    }
    .tool img {
      max-width: 100%;
      max-height: 100%;
    }
    /* Zoom Controls */
    #zoom-controls {
      position: fixed;
      top: 240px;
      right: 20px;
      z-index: 20;
      display: flex;
      flex-direction: column;
      gap: 5px;
      background: rgba(30,30,30,0.9);
      padding: 10px;
      border: 1px solid rgba(223,197,136,0.5);
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(223,197,136,0.5);
    }
    #zoom-controls button {
      padding: 8px;
      border: none;
      border-radius: 4px;
      background: rgba(223,197,136,0.8);
      color: white;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      box-shadow: 0 4px 15px rgba(223,197,136,0.5);
    }
    #zoom-controls button:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(223,197,136,0.9);
    }
    /* Map container */
    #map-container {
      width: 100vw;
      height: calc(100vh - 60px);
      overflow: hidden;
    }
    #map-svg-container {
      width: 100%;
      height: 100%;
    }
    .marker:hover {
      opacity: 0.8;
      cursor: pointer;
    }
    /* Error overlay */
    #error-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(30,30,30,0.95);
      color: #ecf0f1;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      font-size: 1.5em;
      text-align: center;
      padding: 20px;
    }
    /* Admin panel */
    #admin-panel {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 320px;
      background: rgba(30,30,30,0.9);
      border: 1px solid rgba(223,197,136,0.5);
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(223,197,136,0.5);
      padding: 10px;
      z-index: 30;
      display: none;
      animation: fadeIn 1s ease-out;
    }
    #admin-panel h3 {
      margin-top: 0;
      font-size: 1.8em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(223,197,136,0.5);
      padding-bottom: 5px;
      margin-bottom: 10px;
    }
    #admin-panel h3 span.icon {
      cursor: pointer;
      margin-left: 5px;
      font-size: 1.2em;
    }
    #audit-log {
      font-size: 0.9em;
      height: 200px;
      overflow-y: auto;
      margin-bottom: 10px;
      border-top: 1px solid rgba(223,197,136,0.5);
      padding-top: 5px;
    }
    #delete-all {
      padding: 8px;
      border: none;
      border-radius: 4px;
      background: rgba(223,197,136,0.8);
      color: white;
      cursor: pointer;
      width: 100%;
      transition: transform 0.3s, box-shadow 0.3s;
      box-shadow: 0 4px 15px rgba(223,197,136,0.5);
    }
    #delete-all:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(223,197,136,0.9);
    }
  </style>
</head>
<body>
  <!-- Animated waves background -->
  <div id="background-container">
    <canvas id="waveCanvas"></canvas>
  </div>

  <!-- Loading overlay -->
  <div id="loading-overlay">
    <img src="https://regnumsolis.com/planner/images/loading.gif" alt="Loading">
    <div id="loading-text">0%</div>
  </div>

  <!-- Login Screen -->
  <div id="login-screen">
    <h2>Login</h2>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <button id="login-button">Login</button>
    <div id="login-error"></div>
  </div>

  <!-- Main App -->
  <div id="app">
    <!-- Header with text -->
    <div id="header-logo">
      <h1>Crafted by the Regnum Solis Research and Development Team for the usage of the Remnants Senate</h1>
    </div>

    <!-- Map Change Controls -->
    <div id="map-change-container">
      <h2>Change Maps</h2>
      <!-- New button: Visibility Map -->
      <button id="visibility-map">Visibility Map</button>
      <!-- New button: Dark Visibility -->
      <button id="dark-visibility">Dark Visibility</button>
      <!-- Renamed from Tactical Map -->
      <button id="color-scan">Color Scan</button>
      <!-- Renamed from current Visibility Map -->
      <button id="dark-scan">Dark Scan</button>
    </div>

    <!-- Toolbox, Zoom, Map -->
    <div id="toolbox">
      <div class="tool" draggable="true" data-type="marker" title="Text Marker">
        <img src="https://regnumsolis.com/planner/images/marker.svg" alt="Marker Background">
      </div>
      <div class="tool" draggable="true" data-type="citadel" title="Citadel">
        <img src="https://regnumsolis.com/planner/images/citadel.svg" alt="Citadel">
      </div>
      <div class="tool" draggable="true" data-type="torch" title="Torch">
        <img src="https://regnumsolis.com/planner/images/torch.svg" alt="Torch">
      </div>
      <div class="tool" draggable="true" data-type="cave" title="Cave">
        <img src="https://regnumsolis.com/planner/images/cave.svg" alt="Cave">
      </div>
      <div class="tool" draggable="true" data-type="sword" title="Sword">
        <img src="https://regnumsolis.com/planner/images/sword.svg" alt="Sword">
      </div>
      <div class="tool" draggable="true" data-type="spear" title="Spear">
        <img src="https://regnumsolis.com/planner/images/spear.svg" alt="Spear">
      </div>
      <div class="tool" draggable="true" data-type="bow" title="Bow">
        <img src="https://regnumsolis.com/planner/images/bow.svg" alt="Bow">
      </div>
      <div class="tool" data-type="line" title="Line Draw">
        <img src="https://regnumsolis.com/planner/images/line.svg" alt="Line Draw" onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22><text x=%220%22 y=%2230%22 fill=%22white%22 font-size=%2230%22>‚Äï</text></svg>'">
      </div>
    </div>

    <div id="zoom-controls">
      <button id="zoom-in">Zoom In</button>
      <button id="zoom-out">Zoom Out</button>
      <button id="reset-zoom">Reset</button>
    </div>

    <div id="map-container">
      <div id="map-svg-container"></div>
    </div>

    <div id="admin-panel">
      <h3>
        Audit log
        <span>
          <span id="delete-audit" class="icon" title="Delete all audit logs">üóëÔ∏è</span>
          <span id="minimize-audit" class="icon" title="Minimize audit log">‚ûñ</span>
        </span>
      </h3>
      <div id="audit-log"></div>
      <button id="delete-all">Delete All Markers</button>
    </div>
  </div>

  <div id="error-overlay">Database connection failed. The app cannot be used at this time.</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, orderBy, query, onSnapshot, deleteDoc, doc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIws_FKV_CTaiHdnwc8WigDqRkyUCOjtE",
      authDomain: "regnum-d3ddf.firebaseapp.com",
      projectId: "regnum-d3ddf",
      storageBucket: "regnum-d3ddf.firebasestorage.app",
      messagingSenderId: "565532905074",
      appId: "1:565532905074:web:a4cc38363376e49540fceb",
      measurementId: "G-4RG5NP4FZ3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let panZoomInstance, svgRoot, panLayer, lineLayer, markerLayer;
    let isMapReady = false;
    const adminEmail = "gryves_dev@yahoo.com";

    let activeTool = null;
    let lineDrawingState = 0;
    let currentLine = null;
    let currentLineGroup = null;

    // Loading simulation
    let loadingInterval;
    let currentProgress = 0;
    const loadingOverlay = document.getElementById("loading-overlay");
    const loadingText = document.getElementById("loading-text");

    document.addEventListener("DOMContentLoaded", () => {
      setupLogin();
      setupToolbox();
      setupAuditControls();
      setupMapSwitchControls();
    });

    function showLoading() {
      currentProgress = 0;
      loadingText.textContent = "0%";
      loadingOverlay.style.display = "flex";
      loadingInterval = setInterval(() => {
        if (currentProgress < 90) {
          currentProgress += Math.floor(Math.random() * 3) + 1;
          if (currentProgress > 90) currentProgress = 90;
          loadingText.textContent = currentProgress + "%";
        }
      }, 100);
    }

    function hideLoading() {
      clearInterval(loadingInterval);
      loadingText.textContent = "100%";
      setTimeout(() => {
        loadingOverlay.style.display = "none";
      }, 300);
    }

    function setupLogin() {
      document.getElementById("login-button").addEventListener("click", () => {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();
        const errorDiv = document.getElementById("login-error");

        signInWithEmailAndPassword(auth, email, password)
          .then(() => {
            errorDiv.textContent = "";
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("app").style.display = "block";
            initializeMap();
          })
          .catch((error) => {
            errorDiv.textContent = error.message;
          });
      });

      onAuthStateChanged(auth, (user) => {
        if (user) {
          document.getElementById("login-screen").style.display = "none";
          document.getElementById("app").style.display = "block";
          initializeMap();
          if (user.email === adminEmail) {
            document.getElementById("admin-panel").style.display = "block";
            listenForAuditLogs();
            setupDeleteAll();
          }
        } else {
          document.getElementById("login-screen").style.display = "flex";
          document.getElementById("app").style.display = "none";
        }
      });
    }

    // Set default map to the new main map.
    function initializeMap() {
      switchMap("https://regnumsolis.com/planner/images/mvmvmdfs.svg");
    }

    // switchMap shows the loading overlay, fetches the SVG, then initializes pan/zoom and listeners.
    function switchMap(url) {
      if (panZoomInstance) {
        panZoomInstance.destroy();
      }
      isMapReady = false;
      const container = document.getElementById("map-svg-container");
      showLoading();
      fetch(url)
        .then(response => response.text())
        .then(svgText => {
          container.innerHTML = svgText;
          setupPanZoomLayers();
          setupZoomControls();
          setupDragAndDrop();
          setupLineDrawing();
          listenForMarkers();
          listenForLines();
          isMapReady = true;
          hideLoading();
        })
        .catch(error => {
          console.error("Error loading SVG:", error);
          displayErrorOverlay("Error loading map data.");
          hideLoading();
        });
    }

    // Setup the map change buttons with new names and URLs.
    function setupMapSwitchControls() {
      // New button: Visibility Map
      document.getElementById("visibility-map").addEventListener("click", () => {
        switchMap("https://regnumsolis.com/planner/images/mvmvmdfs.svg");
      });
      // New button: Dark Visibility
      document.getElementById("dark-visibility").addEventListener("click", () => {
        switchMap("https://regnumsolis.com/planner/images/darkvisibility.svg");
      });
      // Renamed from Tactical Map to Color Scan (old main map)
      document.getElementById("color-scan").addEventListener("click", () => {
        switchMap("https://regnumsolis.com/planner/images/map.svg");
      });
      // Renamed from current Visibility Map to Dark Scan
      document.getElementById("dark-scan").addEventListener("click", () => {
        switchMap("https://regnumsolis.com/planner/images/darkmap.svg");
      });
    }

    function setupPanZoomLayers() {
      svgRoot = document.getElementById("map-svg-container").querySelector("svg");
      svgRoot.setAttribute("width", "100%");
      svgRoot.setAttribute("height", "100%");
      svgRoot.setAttribute("preserveAspectRatio", "xMidYMid meet");

      panLayer = document.createElementNS("http://www.w3.org/2000/svg", "g");
      panLayer.id = "pan-layer";
      while (svgRoot.firstChild) {
        panLayer.appendChild(svgRoot.firstChild);
      }
      svgRoot.appendChild(panLayer);

      lineLayer = document.createElementNS("http://www.w3.org/2000/svg", "g");
      lineLayer.id = "line-layer";
      panLayer.appendChild(lineLayer);

      markerLayer = document.createElementNS("http://www.w3.org/2000/svg", "g");
      markerLayer.id = "marker-layer";
      panLayer.appendChild(markerLayer);

      panZoomInstance = svgPanZoom(svgRoot, {
        zoomEnabled: true,
        panEnabled: true,
        controlIconsEnabled: false,
        minZoom: 0.5,
        maxZoom: 5,
        beforeMouseDown: function(e) {
          if (activeTool === "line") return false;
          if (e.target.getAttribute("data-marker") === "true" ||
              (e.target.parentNode && e.target.parentNode.getAttribute("data-marker") === "true")) {
            return false;
          }
          return true;
        }
      });
    }

    function setupZoomControls() {
      document.getElementById("zoom-in").addEventListener("click", () => panZoomInstance.zoomIn());
      document.getElementById("zoom-out").addEventListener("click", () => panZoomInstance.zoomOut());
      document.getElementById("reset-zoom").addEventListener("click", () => panZoomInstance.resetZoom());
    }

    function setupToolbox() {
      document.querySelectorAll(".tool").forEach((tool) => {
        const type = tool.dataset.type;
        if (type === "line") {
          tool.addEventListener("click", () => {
            activeTool = "line";
            lineDrawingState = 0;
            markerLayer.style.pointerEvents = "none";
            document.querySelectorAll(".tool").forEach(t => t.style.borderColor = "rgba(223,197,136,0.5)");
            tool.style.borderColor = "red";
          });
        } else {
          tool.addEventListener("dragstart", (e) => {
            e.dataTransfer.setData("text/plain", type);
          });
        }
      });
    }

    function setupAuditControls() {
      document.getElementById("delete-audit").addEventListener("click", async () => {
        if (confirm("Delete all audit logs?")) {
          try {
            const auditSnapshot = await getDocs(collection(db, "auditLogs"));
            auditSnapshot.forEach(async (docSnap) => {
              await deleteDoc(doc(db, "auditLogs", docSnap.id));
            });
          } catch (error) {
            console.error("Error deleting audit logs:", error);
          }
        }
      });

      document.getElementById("minimize-audit").addEventListener("click", () => {
        const auditLogDiv = document.getElementById("audit-log");
        if (auditLogDiv.style.display === "none") {
          auditLogDiv.style.display = "block";
          document.getElementById("minimize-audit").textContent = "‚ûñ";
        } else {
          auditLogDiv.style.display = "none";
          document.getElementById("minimize-audit").textContent = "‚ûï";
        }
      });
    }

    function getSVGPoint(e) {
      const pt = svgRoot.createSVGPoint();
      pt.x = e.clientX;
      pt.y = e.clientY;
      return pt.matrixTransform(panLayer.getScreenCTM().inverse());
    }

    function setupDragAndDrop() {
      svgRoot.addEventListener("dragover", (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
      });

      svgRoot.addEventListener("drop", async (e) => {
        if (!isMapReady || activeTool === "line") return;
        e.preventDefault();
        const type = e.dataTransfer.getData("text/plain");
        const cursorPos = getSVGPoint(e);
        await addMarkerToFirestore(type, cursorPos.x, cursorPos.y);
      });
    }

    function setupLineDrawing() {
      svgRoot.addEventListener("click", async (e) => {
        if (activeTool !== "line") return;
        e.preventDefault();
        const pt = getSVGPoint(e);

        if (lineDrawingState === 0) {
          currentLineGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
          currentLineGroup.classList.add("line-group");

          const lineColor = prompt("Enter line color (e.g., red or #ff0000):") || "white";
          
          currentLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
          currentLine.setAttribute("x1", pt.x);
          currentLine.setAttribute("y1", pt.y);
          currentLine.setAttribute("x2", pt.x);
          currentLine.setAttribute("y2", pt.y);
          currentLine.setAttribute("stroke-width", "3.2");
          currentLine.setAttribute("stroke", lineColor);

          currentLineGroup.startPoint = { x: pt.x, y: pt.y };
          currentLineGroup.lineColor = lineColor;
          currentLineGroup.appendChild(currentLine);
          lineLayer.appendChild(currentLineGroup);

          lineDrawingState = 1;
        } else if (lineDrawingState === 1) {
          const x1 = currentLineGroup.startPoint.x;
          const y1 = currentLineGroup.startPoint.y;
          const x2 = pt.x;
          const y2 = pt.y;

          currentLine.setAttribute("x2", x2);
          currentLine.setAttribute("y2", y2);

          const midX = (x1 + x2) / 2;
          const midY = (y1 + y2) / 2;
          const angle = Math.atan2(y2 - y1, x2 - x1) * (180 / Math.PI);

          const arrow = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
          arrow.setAttribute("points", "0,-8 16,0 0,8");
          arrow.setAttribute("fill", currentLineGroup.lineColor);
          arrow.setAttribute("transform", `translate(${midX},${midY}) rotate(${angle})`);
          currentLineGroup.appendChild(arrow);

          await addLineToFirestore({
            x1, y1, x2, y2,
            color: currentLineGroup.lineColor,
            midX, midY, angle
          });

          activeTool = null;
          lineDrawingState = 0;
          currentLine = null;
          currentLineGroup = null;
          markerLayer.style.pointerEvents = "auto";
          document.querySelectorAll(".tool").forEach(t => t.style.borderColor = "rgba(223,197,136,0.5)");
        }
      });
    }

    async function addMarkerToFirestore(type, x, y) {
      let markerData = { type, x, y, timestamp: serverTimestamp() };
      if (["marker", "citadel", "torch", "cave", "sword", "spear", "bow"].includes(type)) {
        markerData.text = prompt("Enter marker text:") || "";
        markerData.color = prompt("Enter marker color (e.g., red or #ff0000):") || "black";
        if (type === "marker" && markerData.text === "") {
          markerData.text = "M";
        }
      }
      try {
        const docRef = await addDoc(collection(db, "markers"), markerData);
        recordAuditLog("add", { markerId: docRef.id, markerType: type });
      } catch (error) {
        console.error("Error adding marker:", error);
      }
    }

    async function addLineToFirestore(lineData) {
      try {
        const docRef = await addDoc(collection(db, "lines"), {
          ...lineData,
          timestamp: serverTimestamp()
        });
        recordAuditLog("add_line", { lineId: docRef.id });
      } catch (error) {
        console.error("Error adding line:", error);
      }
    }

    function listenForMarkers() {
      let snapshotReceived = false;
      const markersQuery = query(collection(db, "markers"), orderBy("timestamp"));
      const unsubscribe = onSnapshot(markersQuery, (snapshot) => {
        snapshotReceived = true;
        while (markerLayer.firstChild) {
          markerLayer.removeChild(markerLayer.firstChild);
        }
        snapshot.forEach((docSnap) => {
          createMarkerElement(docSnap.id, docSnap.data());
        });
      }, (error) => {
        console.error("Firestore connection error:", error);
        displayErrorOverlay("Firestore connection failed.");
      });

      setTimeout(() => {
        if (!snapshotReceived) {
          console.error("No Firestore snapshot received within timeout.");
          displayErrorOverlay("Firestore connection failed.");
          unsubscribe();
        }
      }, 5000);
    }

    function listenForLines() {
      const linesQuery = query(collection(db, "lines"), orderBy("timestamp"));
      onSnapshot(linesQuery, (snapshot) => {
        lineLayer.innerHTML = "";
        snapshot.forEach((docSnap) => {
          createLineElement(docSnap.id, docSnap.data());
        });
      });
    }

    function createMarkerElement(id, data) {
      let markerEl = document.createElementNS("http://www.w3.org/2000/svg", "g");
      markerEl.setAttribute("data-marker", "true");

      let imgSrc, imgWidth, imgHeight, imgXOffset, imgYOffset, fontSize;
      if (data.type === "marker") {
        imgSrc = "https://regnumsolis.com/planner/images/marker.svg";
        imgWidth = 30 * 1.7;
        imgHeight = 30 * 1.7;
        imgXOffset = -(imgWidth / 2);
        imgYOffset = -20 * 1.7;
        fontSize = 16 * 1.7;
      } else if (data.type === "citadel") {
        imgSrc = "https://regnumsolis.com/planner/images/citadel.svg";
        imgWidth = 30 * 1.7 * 1.2;
        imgHeight = 30 * 1.7 * 1.2;
        imgXOffset = -15 * 1.7 * 1.2;
        imgYOffset = -15 * 1.7 * 1.2;
        fontSize = 14 * 1.7 * 1.2;
      } else if (data.type === "torch") {
        imgSrc = "https://regnumsolis.com/planner/images/torch.svg";
        imgWidth = 30 * 1.7;
        imgHeight = 30 * 1.7;
        imgXOffset = -15 * 1.7;
        imgYOffset = -15 * 1.7;
        fontSize = 14 * 1.7;
      } else if (data.type === "cave") {
        imgSrc = "https://regnumsolis.com/planner/images/cave.svg";
        imgWidth = 30 * 1.7;
        imgHeight = 30 * 1.7;
        imgXOffset = -15 * 1.7;
        imgYOffset = -15 * 1.7;
        fontSize = 14 * 1.7;
      } else if (data.type === "sword") {
        imgSrc = "https://regnumsolis.com/planner/images/sword.svg";
        imgWidth = 30 * 1.7;
        imgHeight = 30 * 1.7;
        imgXOffset = -15 * 1.7;
        imgYOffset = -15 * 1.7;
        fontSize = 14 * 1.7;
      } else if (data.type === "spear") {
        imgSrc = "https://regnumsolis.com/planner/images/spear.svg";
        imgWidth = 30 * 1.7;
        imgHeight = 30 * 1.7;
        imgXOffset = -15 * 1.7;
        imgYOffset = -15 * 1.7;
        fontSize = 14 * 1.7;
      } else if (data.type === "bow") {
        imgSrc = "https://regnumsolis.com/planner/images/bow.svg";
        imgWidth = 30 * 1.7;
        imgHeight = 30 * 1.7;
        imgXOffset = -15 * 1.7;
        imgYOffset = -15 * 1.7;
        fontSize = 14 * 1.7;
      }
      let textXOffset = imgXOffset + imgWidth;

      const imgEl = document.createElementNS("http://www.w3.org/2000/svg", "image");
      imgEl.setAttributeNS("http://www.w3.org/1999/xlink", "href", imgSrc);
      imgEl.setAttribute("width", imgWidth);
      imgEl.setAttribute("height", imgHeight);
      imgEl.setAttribute("x", data.x + imgXOffset);
      imgEl.setAttribute("y", data.y + imgYOffset);
      markerEl.appendChild(imgEl);

      const textEl = document.createElementNS("http://www.w3.org/2000/svg", "text");
      textEl.textContent = data.text;
      textEl.setAttribute("fill", data.color);
      textEl.setAttribute("font-size", fontSize);
      textEl.setAttribute("x", data.x + textXOffset);
      textEl.setAttribute("y", data.y);
      textEl.setAttribute("text-anchor", "start");
      textEl.setAttribute("dominant-baseline", "middle");
      textEl.style.fontFamily = "'Bebas Neue', sans-serif";
      markerEl.appendChild(textEl);

      requestAnimationFrame(() => {
        const bbox = textEl.getBBox();
        const textLength = textEl.getComputedTextLength();
        const rectEl = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        rectEl.setAttribute("x", bbox.x);
        rectEl.setAttribute("y", bbox.y);
        rectEl.setAttribute("width", textLength);
        rectEl.setAttribute("height", bbox.height);
        rectEl.setAttribute("fill", "#1e1e1e");
        rectEl.setAttribute("opacity", "0.63");
        markerEl.insertBefore(rectEl, textEl);
      });

      markerEl.classList.add("marker");
      markerEl.dataset.id = id;
      markerEl.addEventListener("click", async (e) => {
        e.stopPropagation();
        if (activeTool === "line") return;
        if (confirm("Delete this marker?")) {
          try {
            await deleteDoc(doc(db, "markers", id));
            recordAuditLog("delete", { markerId: id, markerType: data.type });
          } catch (error) {
            console.error("Error deleting marker:", error);
          }
        }
      });
      markerLayer.appendChild(markerEl);
    }

    function createLineElement(id, data) {
      const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
      group.classList.add("line-group");
      group.dataset.id = id;

      const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      line.setAttribute("x1", data.x1);
      line.setAttribute("y1", data.y1);
      line.setAttribute("x2", data.x2);
      line.setAttribute("y2", data.y2);
      line.setAttribute("stroke", data.color);
      line.setAttribute("stroke-width", "3.2");

      const arrow = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
      arrow.setAttribute("points", "0,-8 16,0 0,8");
      arrow.setAttribute("fill", data.color);
      arrow.setAttribute("transform", `translate(${data.midX},${data.midY}) rotate(${data.angle})`);

      group.appendChild(line);
      group.appendChild(arrow);
      
      group.addEventListener("click", async (e) => {
        e.stopPropagation();
        if (confirm("Delete this line?")) {
          await deleteDoc(doc(db, "lines", id));
          recordAuditLog("delete_line", { lineId: id });
        }
      });

      lineLayer.appendChild(group);
    }

    function recordAuditLog(action, details) {
      const user = auth.currentUser;
      if (!user) return;
      const logData = {
        action,
        details,
        user: user.email,
        timestamp: serverTimestamp()
      };
      addDoc(collection(db, "auditLogs"), logData)
        .catch(error => console.error("Error writing audit log:", error));
    }

    function listenForAuditLogs() {
      const auditLogContainer = document.getElementById("audit-log");
      const auditQuery = query(collection(db, "auditLogs"), orderBy("timestamp", "asc"));
      onSnapshot(auditQuery, (snapshot) => {
        const logs = [];
        snapshot.forEach((docSnap) => {
          const log = docSnap.data();
          const ts = log.timestamp ? log.timestamp.seconds : 0;
          logs.push({ timestamp: ts, log });
        });

        const groupedLogs = [];
        const groupingThreshold = 300;
        let currentGroup = null;

        logs.forEach(item => {
          const { timestamp, log } = item;
          const applicable = (log.action === "add" || log.action === "delete" || log.action === "add_line" || log.action === "delete_line") && log.details;
          if (applicable) {
            if (
              currentGroup &&
              currentGroup.key.user === log.user &&
              currentGroup.key.action === log.action &&
              currentGroup.key.markerType === (log.details.markerType || log.details.lineId?.substr(0, 5))
            ) {
              if (timestamp - currentGroup.lastTimestamp <= groupingThreshold) {
                currentGroup.count += 1;
                currentGroup.lastTimestamp = timestamp;
              } else {
                groupedLogs.push(currentGroup);
                currentGroup = {
                  key: { 
                    user: log.user, 
                    action: log.action,
                    markerType: log.details.markerType || "line"
                  },
                  count: 1,
                  timestamp: timestamp,
                  lastTimestamp: timestamp
                };
              }
            } else {
              if (currentGroup) {
                groupedLogs.push(currentGroup);
              }
              currentGroup = {
                key: { 
                  user: log.user, 
                  action: log.action,
                  markerType: log.details.markerType || "line"
                },
                count: 1,
                timestamp: timestamp,
                lastTimestamp: timestamp
              };
            }
          } else {
            if (currentGroup) {
              groupedLogs.push(currentGroup);
              currentGroup = null;
            }
            groupedLogs.push({
              key: { 
                user: log.user, 
                action: log.action,
                markerType: (log.details && log.details.markerType) ? log.details.markerType : null 
              },
              count: 1,
              timestamp: timestamp,
              lastTimestamp: timestamp
            });
          }
        });
        if (currentGroup) groupedLogs.push(currentGroup);

        groupedLogs.sort((a, b) => b.lastTimestamp - a.lastTimestamp);
        auditLogContainer.innerHTML = "";
        groupedLogs.forEach(group => {
          const dateStr = new Date(group.lastTimestamp * 1000).toLocaleString();
          let actionText = "";
          if (group.key.action === "add") actionText = "add marker";
          else if (group.key.action === "delete") actionText = "delete marker";
          else if (group.key.action === "delete_all") actionText = "delete all content";
          else if (group.key.action === "add_line") actionText = "add line";
          else if (group.key.action === "delete_line") actionText = "delete line";
          else actionText = group.key.action;

          let entryHTML = `[${dateStr}] <b>${group.key.user}</b> ${actionText}`;
          if (group.key.markerType) entryHTML += ` <b>[${group.key.markerType}]</b>`;
          if (group.count > 1) entryHTML += ` (<b>x${group.count}</b>)`;

          const entry = document.createElement("div");
          entry.innerHTML = entryHTML;
          auditLogContainer.appendChild(entry);
        });
      });
    }

    function setupDeleteAll() {
      document.getElementById("delete-all").addEventListener("click", async () => {
        if (confirm("Delete all markers and lines?")) {
          try {
            const markersSnapshot = await getDocs(collection(db, "markers"));
            markersSnapshot.forEach(async (docSnap) => {
              await deleteDoc(doc(db, "markers", docSnap.id));
            });
            
            const linesSnapshot = await getDocs(collection(db, "lines"));
            linesSnapshot.forEach(async (docSnap) => {
              await deleteDoc(doc(db, "lines", docSnap.id));
            });

            recordAuditLog("delete_all", { 
              markers: markersSnapshot.size,
              lines: linesSnapshot.size
            });
            
            lineLayer.innerHTML = "";
          } catch (error) {
            console.error("Error deleting all content:", error);
          }
        }
      });
    }

    function displayErrorOverlay(message) {
      const overlay = document.getElementById("error-overlay");
      overlay.textContent = message;
      overlay.style.display = "flex";
      console.warn("Error overlay activated:", message);
    }
  </script>
  <script>
    // Animated waves background script with updated gradient colors
    const canvas = document.getElementById('waveCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    
    function resize() {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();
    
    let phase = 0;
    const numWaves = 20;
    const amplitude = 20;
    const wavelength = width / 2;
    const speed = 0.003;
    
    function animate() {
      ctx.clearRect(0, 0, width, height);
      
      // New gradient: top rgb(24,35,38) and bottom rgb(24,35,49)
      const bgGradient = ctx.createLinearGradient(0, 0, 0, height);
      bgGradient.addColorStop(0, 'rgb(24,35,38)');
      bgGradient.addColorStop(1, 'rgb(24,35,49)');
      ctx.fillStyle = bgGradient;
      ctx.fillRect(0, 0, width, height);
      
      for (let i = 0; i < numWaves; i++) {
        const yPos = ((i + 0.5) / numWaves) * height;
        ctx.beginPath();
        ctx.moveTo(0, yPos);
        for (let x = 0; x <= width; x++) {
          const offset = amplitude * Math.sin((x / wavelength) * Math.PI * 2 + phase + i);
          ctx.lineTo(x, yPos + offset);
        }
        ctx.strokeStyle = 'rgba(255,255,255,0.1)';
        ctx.lineWidth = 1;
        ctx.stroke();
      }
      
      phase += speed;
      requestAnimationFrame(animate);
    }
    
    animate();
  </script>
</body>
</html>
